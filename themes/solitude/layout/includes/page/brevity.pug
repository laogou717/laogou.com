if page.banner
    include ../widgets/page/banner
if theme.brevity.enable
    //- 通过 helper 汇总 YAML 短文 + 文章型随记，避免在 Pug 中写复杂 JS
    - var brevities = brevity_items()
    #bber
        section.timeline.page-1
            ul.list.waterfall
                each item in brevities.slice(0, theme.brevity.strip)
                    li.item
                        if theme.brevity.style === 2
                            .meta
                                img.avatar(src=theme.aside.my_card.author.img)
                                .info
                                    span.bber_nick= config.author
                                    time.datetime.bber_date(datetime=moment(item.date).format())
                                if theme.comment.use && item.content
                                    if item.commentLink
                                        a.bber-reply.goComment(href=url_for(item.commentLink))
                                            i.solitude.fas.fa-comment
                                    else
                                        a.bber-reply.goComment(onclick=`sco.toTalk('${item.content}')`)
                                            i.solitude.fas.fa-comment

                        #bber-content
                            p.datacont= item.content
                            if item.image
                                .bber-content-img
                                    each img in item.image
                                        if typeof img === 'string'
                                            img(src=img, alt=item.content || "图片暂无描述")
                                        else
                                            img(src=img.url, alt=(img.alt || item.content || "图片暂无描述"))

                        if item.aplayer
                            .bber-music
                                meting-js(server=item.aplayer.server type="song" id=item.aplayer.id mutex="true" preload="none" theme="var(--efu-main)" data-lrctype="0")

                        if item.video
                            .bber-video
                                if item.video.player
                                    video(src=item.video.player controls="controls" style="object-fit: cover;")
                                if item.video.bilibili
                                    iframe(src='//player.bilibili.com/player.html?autoplay=0&bvid=' + item.video.bilibili scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true")

                        if theme.brevity.style === 1
                            hr
                            .bber-bottom
                                .bber-info
                                    .bber-info-time
                                        i.solitude.fas.fa-calendar-day
                                        time.datetime(datetime=moment(item.date).format())
                                    if item.location
                                        .bber-info-location
                                            i.solitude.fas.fa-location-dot
                                            = item.location
                                    if item.link
                                        if item.commentLink
                                            a.bber-content-link(href=url_for(item.link))
                                                i.solitude.fas.fa-book-open
                                                | 查看日记
                                        else
                                            a.bber-content-link(href=url_for(item.link) target="_blank")
                                                i.solitude.fas.fa-link
                                                = _p('essay.link')
                                if theme.comment.use && item.content
                                    if item.commentLink
                                        a.bber-reply(href=url_for(item.commentLink))
                                            i.solitude.fas.fa-comment
                                    else
                                        a.bber-reply(onclick=`sco.toTalk('${item.content}')`)
                                            i.solitude.fas.fa-comment

        // Essay 页：轻量绑定 lightbox + 节流刷新瀑布流，减少多次重绑
        script.
            (function(){
              var $bber = document.getElementById('bber');
              if (!$bber) return;

              function bindOnce() {
                if (!(window.GLOBAL_CONFIG && GLOBAL_CONFIG.lightbox)) return false;
                var ready = (GLOBAL_CONFIG.lightbox === 'mediumZoom' && window.mediumZoom)
                          || (GLOBAL_CONFIG.lightbox === 'fancybox' && window.Fancybox);
                if (!ready) return false;
                var imgs = $bber.querySelectorAll('.bber-content-img img');
                if (imgs && imgs.length) utils.lightbox(imgs);
                return true;
              }

              var run = utils.throttle(function(){
                if (!bindOnce()) {
                  // 轻量重试，等待 lightbox 脚本加载完成
                  var tries = 0;
                  (function retry(){
                    if (tries++ > 8) return;
                    if (!bindOnce()) setTimeout(retry, 200);
                  })();
                }
                if (window.sco && typeof sco.refreshWaterFall === 'function') {
                  sco.refreshWaterFall();
                }
              }, 300);

              // 首次绑定与一次微延迟
              run();
              setTimeout(run, 200);

              // 图片加载后再触发（节流）
              $bber.querySelectorAll('img').forEach(function(img){
                img.addEventListener('load', run, { once: true });
                img.addEventListener('error', run, { once: true });
              });

              // 观察节点变化（新增/替换），触发一次节流的重排与绑定
              if ('MutationObserver' in window) {
                var mo = new MutationObserver(run);
                mo.observe($bber, { childList: true, subtree: true });
              }
            })();
            #bber-tips
                if theme.brevity.strip === -1
                    = _p('essay.tip0')
                else
                    = _p('essay.tip1').replace('#{count}', theme.brevity.strip)
