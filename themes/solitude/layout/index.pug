//- ===========================================
//- 首页模板
//- ===========================================

extends includes/layout

include includes/mixins/common.pug

//- 首页顶部区域组件
mixin homeTop()
  +conditionalWrapper(theme.hometop.enable || (theme.brevity.home_mini && theme.brevity.enable))
    #home_top
      if theme.brevity.home_mini && theme.brevity.enable
        include ./includes/widgets/home/bbTimeList
      if theme.hometop.enable && is_home_first_page()
        include ./includes/widgets/home/hometop

//- 分类栏组件
mixin categoryBar()
  #category-bar
    include ./includes/widgets/home/categoryBar

//- 文章列表组件
mixin postsList()
  //- 将热门评论脚本从 .recent-posts 容器外部引入，避免成为 flex 子项影响布局
  +conditionalWrapper(theme.comment.hot_tip.enable)
    include ./includes/widgets/third-party/hot/index.pug

  .recent-posts#recent-posts
    //- 先过滤再分页的逻辑
    - var allPosts = site.posts.sort("-sticky").sort("-date").data
    - var filteredPosts = []
    each post in allPosts
      - var excluded = inCategories(post, theme.home_exclude_categories || [])
      if !post.hide_in_home && !excluded
        - filteredPosts.push(post)
    
    //- 计算分页参数
    - var perPage = config.per_page || 10
    - var currentPage = page.current || 1
    - var totalPosts = filteredPosts.length
    - var totalPages = Math.ceil(totalPosts / perPage)
    - var startIndex = (currentPage - 1) * perPage
    - var endIndex = Math.min(startIndex + perPage, totalPosts)
    - var currentPagePosts = filteredPosts.slice(startIndex, endIndex)
    
    //- 渲染当前页的文章
    each post in currentPagePosts
      include ./includes/widgets/home/postList

    //- 列表尾部广告
    if theme.google_adsense && theme.google_adsense.enable && !theme.google_adsense.auto_ads
      - var placements = theme.google_adsense.placements || {}
      - var tailAd = placements.home_tail || {}
      - var tailVariant = tailAd.variant
      if tailVariant
        - var variants = theme.google_adsense.variants || {}
        - var variant = variants[tailVariant] || {}
        .recent-post-item.google-ads-warp.home-tail-ads
          if variant.title
            .item-headline
              span= variant.title
          +adsenseBlock(tailVariant)

    //- 自定义分页导航
    if totalPages > 1
      nav#pagination
        div.pagination
          - var prevPage = currentPage > 1 ? (currentPage === 2 ? '/' : '/page/' + (currentPage - 1) + '/') : null
          - var nextPage = currentPage < totalPages ? '/page/' + (currentPage + 1) + '/' : null
          
          if prevPage
            a.extend.prev(href=prevPage rel="prev")
              i.solitude.fas.fa-chevron-left
              div.pagination_tips_prev 上一页
          
          - var startPage = Math.max(1, currentPage - 1)
          - var endPage = Math.min(totalPages, currentPage + 1)
          
          if startPage > 1
            a.page-number(href="/") 1
            if startPage > 2
              span.space ...
          
          - for (var i = startPage; i <= endPage; i++)
            if i === currentPage
              span.page-number.current= i
            else
              - var pageUrl = i === 1 ? '/' : '/page/' + i + '/'
              a.page-number(href=pageUrl)= i
          
          if endPage < totalPages
            if endPage < totalPages - 1
              span.space ...
            - var lastPageUrl = '/page/' + totalPages + '/'
            a.page-number(href=lastPageUrl)= totalPages
          
          if nextPage
            a.extend.next(href=nextPage rel="next")
              div.pagination_tips_next 下一页
              i.solitude.fas.fa-chevron-right
          
          div.toPageGroup
            input#toPageText(oninput="value=value.replace(/[^0-9]/g,'')" maxlength="3" title="跳转到" onkeyup="if (this.value === '0') this.value = ''")
            a#toPageButton(onclick="sco.toPage()")
              i.solitude.fas.fa-angles-right

//- 首页主内容组件
mixin homeContent()
  main.layout#content-inner
    #home
      +categoryBar()
      +postsList()
    
    //- 侧边栏
    include ./includes/widgets/aside/aside

block content
  +homeTop()
  +homeContent()
